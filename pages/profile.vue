<template>
    <div class="flex max-lg:flex-col gap-8 grow">
        <div class="w-full lg:w-[30%] flex flex-col gap-2">
            <div class="flex items-center gap-4">
                <p class="font-medium text-xl">{{ user?.login ? `${user?.login}` : '–∑–∞–≥—Ä—É–∑–∫–∞...' }}</p>
                <button @click="isLoginModalShow = true" class="flex cursor-pointer">
                    <Icon class="text-2xl" name="material-symbols-light:edit"/>
                </button>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-1 h-1 rounded-full bg-green-400"></div>
                <p class="-mt-1 text-sm font-mono font-medium text-green-400">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</p>
            </div>
            <div class="w-full h-px bg-white/20 my-2"></div>
            <button @click="tabs = 'settings'" class="cursor-pointer flex items-center gap-2 text-gray-400 text-base p-2 rounded-xl transition-all duration-500 hover:bg-[#201e18] hover:text-white">
                <Icon class="text-xl" name="material-symbols:settings-outline"/>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </button>
            <button @click="tabs = 'subscribtion'" class="cursor-pointer flex items-center gap-2 text-gray-400 text-base p-2 rounded-xl transition-all duration-500 hover:bg-[#201e18] hover:text-white">
                <Icon class="text-xl" name="fluent:payment-16-regular"/>
                <span>–ü–æ–¥–ø–∏—Å–∫–∞</span>
            </button>
            <button @click="tabs = 'stats'" class="cursor-pointer flex items-center gap-2 text-gray-400 text-base p-2 rounded-xl transition-all duration-500 hover:bg-[#201e18] hover:text-white">
                <Icon class="text-xl" name="material-symbols:data-usage-rounded"/>
                <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
            </button>
            <button @click="isSupportModalShow = true" class="cursor-pointer flex items-center gap-2 text-gray-400 text-base p-2 rounded-xl transition-all duration-500 hover:bg-[#201e18] hover:text-white">
                <Icon class="text-xl" name="ic:round-email"/>
                <span>–°–≤—è–∑—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º</span>
            </button>
            <button @click="logout" class="cursor-pointer flex items-center gap-2 text-gray-400 text-base p-2 rounded-xl transition-all duration-500 hover:bg-[#201e18] hover:text-white">
                <Icon class="text-xl" name="solar:logout-broken"/>
                <span>–í—ã—Ö–æ–¥</span>
            </button>
        </div>
        <div class="w-full lg:w-[70%] h-full">
            <!-- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div v-if="tabs === 'settings'" class="flex flex-col gap-6">
                <p class="text-xl font-mono font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                <div class="flex flex-col gap-2">
                    <p class="font-medium ml-2 text-sm text-gray-400">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</p>
                    <div class="flex max-md:flex-col gap-2 md:justify-between md:items-center rounded-xl border border-white/20 p-4">
                        <div class="flex flex-col gap-2">
                            <p class="text-base">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</p>
                            <p class="text-sm text-gray-400">–û–±–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≤–∞—à—É —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å</p>
                        </div>
                        <button @click="isPassModalShow = true" class="cursor-pointer bg-white px-4 py-1.5 rounded-xl font-semibold text-sm text-[#14120B] transition-all duration-500 hover:opacity-70">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <p class="font-medium ml-2 text-sm text-gray-400">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
                    <div class="flex max-md:flex-col gap-2 md:justify-between md:items-center rounded-xl border border-white/20 p-4">
                        <div class="flex flex-col gap-2">
                            <p class="text-base">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
                            <p class="text-sm text-gray-400">{{ user?.id ? `${user?.id}` : '–∑–∞–≥—Ä—É–∑–∫–∞...' }}</p>
                        </div>
                        <button @click="copyToClipboard(user?.id)" class="cursor-pointer bg-white px-4 py-1.5 rounded-xl font-semibold text-sm text-[#14120B] transition-all duration-500 hover:opacity-70">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <p class="font-medium ml-2 text-sm text-gray-400">–ï—â—ë</p>
                    <div class="flex max-md:flex-col gap-2 md:justify-between md:items-center rounded-xl border border-white/20 p-4">
                        <div class="flex flex-col gap-2">
                            <p class="text-base">–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                        </div>
                        <button @click="isDeleteModalShow = true" class="cursor-pointer border border-red-400 px-4 py-1.5 rounded-xl font-semibold text-sm text-red-400 transition-all duration-500 hover:opacity-70">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <!-- –ø–æ–¥–ø–∏—Å–∫–∞ -->
            <div v-if="tabs === 'subscribtion'" class="flex flex-col gap-6">
                <div class="flex flex-col gap-2">
                    <p class="font-medium ml-2 text-sm text-gray-400">–ü–æ–¥–ø–∏—Å–∫–∞</p>
                    <div class="flex max-md:flex-col gap-2 md:justify-between md:items-center rounded-xl border border-white/20 p-4">
                        <div class="flex flex-col gap-2">
                            <p class="text-base">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: <span class="font-semibold">Free</span></p>
                            <p class="text-sm text-gray-400">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: 03.09.2029</p>
                        </div>
                        <button class="border border-green-400 text-green-400 px-4 py-1.5 rounded-xl font-semibold text-sm transition-all duration-500 hover:opacity-70">
                            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div v-if="tabs === 'stats'" class="flex flex-col gap-8">
                <div class="flex flex-col gap-6 p-4 rounded-xl border border-white/20">
                    <div class="flex items-center gap-4">
                        <Icon class="text-3xl" name="fluent:data-usage-16-regular"/>
                        <p class="text-xl md:text-2xl font-mono font-semibold">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="group flex flex-col gap-2 bg-[#201e18] items-center text-center p-4 rounded-xl transition-all duration-500 hover:-translate-y-3 hover:border-green-500/30 hover:shadow-2xl hover:shadow-green-500/10">
                            <div class="flex items-center justify-center p-2 rounded-xl bg-green-500/10 group-hover:scale-110 transition-transform duration-300">
                                <Icon class="text-3xl" name="ic:round-message"/>
                            </div>
                            <p class="text-2xl md:text-3xl font-mono font-semibold">47</p>
                            <p class="text-green-400">–°–æ–æ–±—â–µ–Ω–∏–π</p>
                        </div>
                        <div class="group flex flex-col gap-2 bg-[#201e18] items-center text-center p-4 rounded-xl transition-all duration-500 hover:-translate-y-3 hover:border-blue-500/30 hover:shadow-2xl hover:shadow-blue-500/10">
                            <div class="flex items-center justify-center p-2 rounded-xl bg-blue-500/10 group-hover:scale-110 transition-transform duration-300">
                                <Icon class="text-3xl" name="material-symbols:image"/>
                            </div>
                            <p class="text-2xl md:text-3xl font-mono font-semibold">3</p>
                            <p class="text-blue-400">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                        </div>
                        <div class="group flex flex-col gap-2 bg-[#201e18] items-center text-center p-4 rounded-xl transition-all duration-500 hover:-translate-y-3 hover:border-orange-500/30 hover:shadow-2xl hover:shadow-orange-500/10">
                            <div class="flex items-center justify-center p-2 rounded-xl bg-orange-500/10 group-hover:scale-110 transition-transform duration-300">
                            <Icon class="text-3xl" name="ic:round-smart-toy"/>
                            </div>
                            <p class="text-2xl md:text-3xl font-mono font-semibold">0/5</p>
                            <p class="text-orange-400">–î–∏–∞–ª–æ–≥–æ–≤</p>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-6 p-4 rounded-xl border border-white/20">
                    <p class="text-xl md:text-2xl font-mono font-semibold">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</p>
                    <p class="text-center text-sm text-gray-400">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
                </div>
            </div>
        </div>

        <!-- –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <ProfileModal :is-open="isSupportModalShow" @close="isSupportModalShow = false">
            <p class="text-xl font-mono font-semibold">–°–≤—è–∑—å —Å –Ω–∞–º–∏</p>
            <p class="text-gray-400">–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π –∏ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–ª–µ–≥—Ä–∞–º <a href="https://t.me/fire83274" target="_blank" class="underline font-mono font-semibold text-white">@fire83274</a></p>
        </ProfileModal>

        <ProfileModal :is-open="isLoginModalShow" @close="isLoginModalShow = false">
            <p class="text-xl font-mono font-semibold">–°–º–µ–Ω–∞ –ª–æ–≥–∏–Ω–∞</p>
            <FormKit @submit="updLogin" type="form" :actions="false" messages-class="hidden" form-class="space-y-6">
                <FormKit :value="user?.login" validation="required" placeholder="user_123456" label="–õ–æ–≥–∏–Ω" label-class="hidden" name="login" type="text" messages-class="text-[#E9556D] font-mono" outer-class="w-full" input-class="w-full px-4 py-1.5 rounded-xl border border-white/20 bg-[#14120B]"/>
                <div class="flex items-center gap-2 md:justify-end">
                    <button class="cursor-pointer bg-white px-4 py-1.5 rounded-xl font-semibold text-sm text-[#14120B] transition-all duration-500 hover:opacity-70">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button @click="isLoginModalShow = false" class="cursor-pointer border border-white px-4 py-1.5 rounded-xl font-semibold text-sm text-white transition-all duration-500 hover:opacity-70">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </FormKit>
        </ProfileModal>
        
        <ProfileModal :is-open="isPassModalShow" @close="isPassModalShow = false">
            <p class="text-xl font-mono font-semibold">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</p>
            <FormKit @submit="updPass" type="form" :actions="false" messages-class="hidden" form-class="space-y-6">
                <FormKit validation="required|length:6" placeholder="¬∑¬∑¬∑¬∑¬∑¬∑" label="–ü–∞—Ä–æ–ª—å" label-class="hidden" name="password" type="text" messages-class="text-[#E9556D] font-mono" outer-class="w-full" input-class="w-full px-4 py-1.5 rounded-xl border border-white/20 bg-[#14120B]"/>
                <div class="flex items-center gap-2 md:justify-end">
                    <button class="cursor-pointer bg-white px-4 py-1.5 rounded-xl font-semibold text-sm text-[#14120B] transition-all duration-500 hover:opacity-70">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button @click="isPassModalShow = false" class="cursor-pointer border border-white px-4 py-1.5 rounded-xl font-semibold text-sm text-white transition-all duration-500 hover:opacity-70">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </FormKit>
        </ProfileModal>       

        <ProfileModal :is-open="isDeleteModalShow" @close="isDeleteModalShow = false">
            <p class="text-xl font-mono font-semibold text-red-400">–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
            <p class="text-sm font-medium text-gray-400">–ù–∞–ø–∏—à–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
            <FormKit @submit="deleteAccount" type="form" :actions="false" messages-class="hidden" form-class="space-y-6">
                <FormKit v-model="confirmDelete" validation="required" label="–£–¥–∞–ª–µ–Ω–∏–µ" label-class="hidden" name="delete" type="text" messages-class="text-[#E9556D] font-mono" outer-class="w-full" input-class="w-full px-4 py-1.5 rounded-xl border border-white/20 bg-[#14120B]"/>
                <div class="flex items-center gap-2 md:justify-end">
                    <button :disabled="confirmDelete !== '–£–¥–∞–ª–∏—Ç—å'" :class="confirmDelete === '–£–¥–∞–ª–∏—Ç—å' ? 'cursor-pointer hover:opacity-70' : 'cursor-not-allowed opacity-50'" class="border border-red-400 px-4 py-1.5 rounded-xl font-semibold text-sm text-red-400 transition-all duration-500">–£–¥–∞–ª–∏—Ç—å</button>
                    <button @click="isDeleteModalShow = false" class="cursor-pointer border border-white px-4 py-1.5 rounded-xl font-semibold text-sm text-white transition-all duration-500 hover:opacity-70">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </FormKit>
        </ProfileModal>        
    </div>
  </template>
  
<script setup>
/* –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —è–∑—ã–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
useSeoMeta({
    title: '–ü—Ä–æ—Ñ–∏–ª—å',
    lang: 'ru'
})

/* —Ä–æ—É—Ç–µ—Ä */
const router = useRouter()

/* —Å–æ—Å—Ç–æ—è–Ω–∏—è */
const tabs = ref("settings")
const isSupportModalShow = ref(false)
const isLoginModalShow = ref(false)
const isPassModalShow = ref(false)
const isDeleteModalShow = ref(false)
const confirmDelete = ref("")

/* –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â –∏ –±–¥ */
const { showMessage } = useMessagesStore()
const { id, logout } = useUserStore()
const supabase = useSupabaseClient()

/* –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö */
onMounted(async () => {
    loadUserData()
})

/* –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
const user = ref()
const loadUserData = async () => {
    const { data, error } = await supabase
    .from('website_users')
    .select("*")
    .eq('id', id)
    .single()

    user.value = data
}

/* –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
const loadUserStats = async () => {

}


const getActivityIcon = (type) => {
const icons = {
    message: 'üí¨',
    image: 'üé®',
    login: 'üîê',
    file: 'üìÅ',
    payment: 'üí≥'
}
return icons[type] || '‚ö°'
}

/* –¥–µ–π—Å—Ç–≤–∏—è */  
const contactSupport = () => {

}

const deleteAccount = async() => {
    if(confirmDelete.value === '–£–¥–∞–ª–∏—Ç—å'){        
        const { error } = await supabase
        .from('website_users')
        .delete()
        .eq('id', id)

        if (!error) {
            router.push("/")
            logout()
            return showMessage("–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω!", true) 
        } else {
            return showMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", false) 
        }
    }
}

const updLogin = async(form) => {
    const { data, error } = await supabase
    .from('website_users')
    .update({ login: form.login })
    .eq('id', id)
    .select()

    if (!error) {
        loadUserData()
        isLoginModalShow.value = false
        return showMessage("–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!", true) 
    } else {
        return showMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", false) 
    }
}

const updPass = async(form) => {
    const { data, error } = await supabase
    .from('website_users')
    .update({ password: form.password })
    .eq('id', id)
    .select()

    if (!error) {
        loadUserData()
        isPassModalShow.value = false
        return showMessage("–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!", true) 
    } else {
        return showMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", false) 
    }
}

const copyToClipboard = async (text) => {
  try {
    await navigator.clipboard.writeText(text)
    console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ', text)
    return showMessage('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', true)
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err)
    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
    try {
      const textArea = document.createElement('textarea')
      textArea.value = text
      document.body.appendChild(textArea)
      textArea.select()
      document.execCommand('copy')
      document.body.removeChild(textArea)
      return showMessage('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', true)
    } catch (fallbackErr) {
      return showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç', false)
    }
  }
}
</script>